# AI评论总结功能

## 功能说明

本功能为PiliPlus添加了AI驱动的评论总结能力，可以智能分析和总结B站评论区的讨论内容。

## 主要特性

### 1. AI评论总结
- **触发方式**: 长按一级评论，在弹出菜单中点击"AI总结"
- **适用范围**: 仅对一级评论（楼主评论）生效
- **实时进度**: 在头像下方显示圆形进度指示器
  - 0-90%: 抓取回复进度
  - 90-100%: AI处理阶段
- **结果展示**: 完成后显示绿色勾图标，点击查看总结内容

### 2. 进度指示器
- **进度显示**: 圆形进度条显示当前任务进度
- **可取消**: 点击进度指示器可取消正在进行的总结任务
- **完成状态**: 绿色圆圈+勾表示总结完成，点击查看结果

### 3. 设置配置
- **位置**: 设置 → 其他设置 → AI总结API配置
- **配置项**:
  - API Base URL (例如: https://api.deepseek.com)
  - API Key (sk-开头的密钥)
- **测试功能**: 提供"测试连接"按钮验证配置

## 使用流程

### 步骤1: 配置API
1. 进入"设置" → "其他设置"
2. 找到"AI总结API配置"，点击进入
3. 填写API Base URL和API Key
4. 点击"测试连接"验证配置
5. 保存配置

### 步骤2: 使用总结功能
1. 在视频评论区找到想要总结的一级评论
2. 长按该评论（移动端）或右键点击（桌面端）
3. 在弹出菜单中选择"AI总结"
4. 等待处理完成（头像下方会显示进度）
5. 完成后点击绿色勾图标查看总结

### 步骤3: 查看和管理
- **查看结果**: 点击完成状态的指示器
- **取消任务**: 在处理过程中点击进度指示器
- **复制总结**: 在结果对话框中点击复制按钮

## 技术细节

### 文件结构
```
lib/
├── services/
│   └── ai_summary_service.dart          # AI服务核心逻辑
├── common/widgets/
│   └── ai_summary_progress.dart         # 进度指示器组件
├── pages/
│   ├── setting/models/
│   │   └── extra_settings.dart          # 设置页面集成
│   └── video/reply/widgets/
│       └── reply_item_grpc.dart         # 评论组件集成
└── utils/
    └── storage_key.dart                 # 存储键定义
```

### 工作原理
1. **数据抓取**: 使用B站API获取评论及其所有回复
2. **数据处理**: 将评论转换为CSV格式
3. **AI分析**: 使用OpenAI风格API进行总结
4. **结果展示**: 以对话框形式展示总结结果

### API格式
支持任何符合OpenAI API规范的服务，包括但不限于：
- DeepSeek API
- OpenAI GPT API
- 其他兼容服务

请求格式:
```json
{
  "model": "deepseek-chat",
  "messages": [
    {"role": "user", "content": "..."}
  ],
  "stream": false
}
```

### 提示词设计
AI将从以下维度分析评论：
1. **楼主观点提炼**: 核心论点是什么
2. **舆论阵营**: 支持/反驳/吃瓜的比例
3. **反驳逻辑**: 主要反驳点及引用
4. **总结**: 反映的群体情绪

## 注意事项

1. **隐私保护**: API密钥本地存储，不会上传到服务器
2. **网络要求**: 需要稳定的网络连接访问API服务
3. **Token消耗**: 大量回复会消耗较多Token，请合理使用
4. **性能考虑**: 抓取和处理可能需要较长时间，请耐心等待

## 常见问题

**Q: 为什么点击"AI总结"没有反应？**  
A: 请先在设置中配置API Base URL和API Key。

**Q: 如何获取API Key？**  
A: 访问相应AI服务商网站注册并获取API Key。

**Q: 总结失败怎么办？**  
A: 检查网络连接和API配置，可以使用"测试连接"功能验证。

**Q: 可以总结二级评论吗？**  
A: 目前仅支持一级评论（楼主评论）的总结。

**Q: 总结结果可以导出吗？**  
A: 可以使用复制按钮复制总结内容。

## 未来计划

- [ ] 支持Markdown渲染
- [ ] 添加总结历史记录
- [ ] 支持自定义提示词
- [ ] 支持更多AI服务商
- [ ] 添加总结质量反馈机制
